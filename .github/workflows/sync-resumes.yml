name: Sync Resumes From Canonical Source

# Receives resume artifacts via repository_dispatch and mirrors them into this repo.
# Replace the default GITHUB_TOKEN with a GitHub App token if cross-repo artifact
# downloads require elevated permissions.

on:
  repository_dispatch:
    types:
      - sync-resumes
  workflow_dispatch:
    inputs:
      #checkov:skip=CKV_GHA_7: required
      repository:
        description: "The repository where to download the branding artifact from"
        required: true
        type: string
      run-id:
        description: "The run ID from the branding repository"
        required: true
        type: string
      artifact-id:
        description: "The artifact ID from the branding repository"
        required: true
        type: string

permissions: {}

jobs:
  sync-resume-assets:
    name: Update resume JSON and PDF files
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Parse inputs
        id: parse-inputs
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          REPOSITORY_INPUT: ${{ inputs.repository }}
          RUN_ID_INPUT: ${{ inputs.run-id }}
          ARTIFACT_ID_INPUT: ${{ inputs.artifact-id }}
        with:
          script: |
            let repository;
            let runId;
            let artifactId;

            if (context.eventName === 'repository_dispatch') {
              repository = context.payload.client_payload.repository;
              runId = context.payload.client_payload["run-id"];
              artifactId = context.payload.client_payload["artifact-id"];

            } else {
              repository = process.env.REPOSITORY_INPUT;
              runId = process.env.RUN_ID_INPUT;
              artifactId = process.env.ARTIFACT_ID_INPUT;
            }

            if (!repository) {
              return core.setFailed('Repository is required');
            }
            core.setOutput('repository', repository);

            if (!runId) {
              return core.setFailed('Run ID is required');
            }
            core.setOutput('run-id', runId);

            if (!artifactId) {
              return core.setFailed('Artifact ID is required');
            }
            core.setOutput('artifact-id', artifactId);

            core.info('ðŸ“¦ Branding update received:');
            core.info(`  Artifact ID: ${artifactId}`);
            core.info(`  Repository: ${repository}`);
            core.info(`  Run ID: ${runId}`);

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ vars.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Download artifact
        id: download-artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          repository: ${{ steps.parse-inputs.outputs.repository }}
          run-id: ${{ steps.parse-inputs.outputs.run-id }}
          artifact-ids: ${{ steps.parse-inputs.outputs.artifact-id }}
          github-token: ${{ steps.generate-token.outputs.token }}
          path: ${{ runner.temp }}/resumes-assets-${{ steps.parse-inputs.outputs.run-id }}-${{ steps.parse-inputs.outputs.artifact-id }}

      - name: Copy resume files
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          DOWNLOADED_PATH: ${{ steps.download-artifact.outputs.download-path }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            core.debug("Listing downloaded files:");
            const collectFiles = (directory) => {
              const entries = fs.readdirSync(directory, { withFileTypes: true });
              return entries.flatMap((entry) => {
                const entryPath = path.join(directory, entry.name);
                return entry.isDirectory()
                  ? collectFiles(entryPath)
                  : path.relative(process.env.DOWNLOADED_PATH, entryPath);
              });
            };

            const downloadedFiles = collectFiles(process.env.DOWNLOADED_PATH);
            for (const file of downloadedFiles) {
                core.debug(`- ${file}`);
                let destinationPath;
                if (file.endsWith('.json')){
                  // Move json files to application/src/data/resumes/
                  destinationPath = path.join('src', 'data', 'resumes');
                } else if (file.endsWith('.pdf')){
                  // Move pdf files to application/public/resumes/
                  destinationPath = path.join('public', 'resumes');
                } else {
                  return core.setFailed(`Unexpected file type for file: ${file}`);
                }

                destinationPath = path.join(process.cwd(), 'application', destinationPath, path.basename(file));
                core.debug(`Destination path for ${file} is ${destinationPath}`);                
                const sourcePath = path.join(process.env.DOWNLOADED_PATH, file);
                core.debug(`Source path for ${file} is ${sourcePath}`);
                fs.copyFileSync(sourcePath, destinationPath);
                core.info(`Copied JSON resume file ${file} to ${destinationPath}`);
            }

      - name: Create pull request with updated assets
        uses: hoverkraft-tech/ci-github-common/actions/create-and-merge-pull-request@f24ce3360a8abf9bf386a62ab13d0ae5de5f9d13 # 0.31.7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          branch: resumes-update
          commit-message: |
            chore: update resumes assets
          title: "chore: update resumes assets"
          body: |
            This PR updates the resume JSON and PDF files from the canonical source.
